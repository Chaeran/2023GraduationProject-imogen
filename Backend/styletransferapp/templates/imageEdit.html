{% load static %}
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>ImaGen</title>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans:wght@500;600&display=swap');
    </style>

    <!-- cropper -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.0/cropper.css" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}" /> <!--외부스타일시트 연결-->
    <!-- imageEditor -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.2/css/boxicons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
</head>

<body>
    <nav>
        <div class="wrapper">
            <h1 id="logo"><a href="{% url 'index' %}" style="text-decoration: none; color: inherit;">Imo<span
                        style="color:#B4C8BB">gen</span></a></h1>
            <ul class="menu">
                <li><a href="{% url 'stylegen' %}">StyleTransfer</a></li>
                <li><a href="{% url 'text2img' %}">Text2Imagen</a></li>
                <li><a href="{% url 'imageEdit' %}">ImageEdit</a></li>
            </ul>
        </div>
    </nav>
    <div class="wrapper">
        <section id="aboutme">
            <div>
                <h2 class="title">Image<span style="color:#B4C8BB">Editor</span></h2>
                <p class="article">
                    Image Editor는 사용자가 이미지를 쉽게 편집하고 디자인할 수 있는 웹 플랫폼입니다.<br><br>

                    이 웹 페이지는 다양한 이미지 편집 도구와 함께 사용자 친화적인 인터페이스를 제공하여
                    누구나 손쉽게 이미지를 디자인할 수 있습니다.<br><br>

                    이미지를 편집하고 생성 버튼을 클릭하세요. 이미지를 생성하는 데 특별한 코드가 필요하지 않습니다. 지금 당장 놀라운 예술 작품을 만들어보세요!<br><br>
                </p>
                <div style="text-align: center;">
                    <button class="button" type="button" onclick="openFileInput()">Upload Image</button>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;">
                </div>
            </div>

        </section>


        <section id="aboutme" class="image-section" style="display: block;">
            <div style="margin-bottom: 50px;">
                <h2 class="comment-head">Frame size</h2>
                <form>
                    <div class="frame-buttons">
                        <button type="button" class="button3" onclick="showPhoneDiv()">Phone Frame</button>
                        <button type="button" class="button3" onclick="showTabletDiv()">Tablet Frame</button>
                        <button type="button" class="button3" onclick="showDesktopDiv()">Desktop Frame</button>
                        <button type="button" class="button3" onclick="showWatchDiv()">Watch Frame</button>
                        <div id="phoneframe" style="margin-bottom: 30px; display: none;">
                            <label class="button2">
                                <input type="radio" name="frame-size" value="1170x2532">
                                <span>iPhone 14</span>
                            </label>
                            <label class="button2">
                                <input type="radio" name="frame-size" value="1179x2556">
                                <span>iPhone 14 Pro</span>
                            </label>
                            <label class="button2">
                                <input type="radio" name="frame-size" value="1284x2778">
                                <span>iPhone 14 Plus</span>
                            </label>
                            <label class="button2">
                                <input type="radio" name="frame-size" value="428x932">
                                <span>iPhone 14 Pro Max</span>
                            </label>
                            <label class="button2">
                                <input type="radio" name="frame-size" value="390x844">
                                <span>iPhone 13 / 13 Pro</span>
                            </label>
                            <label class="button2">
                                <input type="radio" name="frame-size" value="375x812">
                                <span>iPhone 13 mini</span>
                            </label>
                            <label class="button2">
                                <input type="radio" name="frame-size" value="320x568">
                                <span>iPhone SE</span>
                            </label>
                        </div>

                        <div id="tabletframe" style="margin-bottom: 30px; display: none;">
                            <label class="button2">
                                <input type="radio" name="frame-size" value="1440x960">
                                <span>iSurface Pro 8</span>
                            </label>
                            <label class="button2">
                                <input type="radio" name="frame-size" value="744x1133">
                                <span>iPad mini 8.3</span>
                            </label>
                            <label class="button2">
                                <input type="radio" name="frame-size" value="834x1194">
                                <span>iPad Pro 11"</span>
                            </label>
                            <label class="button2">
                                <input type="radio" name="frame-size" value="1024x1366">
                                <span>iPad Pro 12.9"</span>
                            </label>
                        </div>

                        <div id="desktopframe" style="margin-bottom: 30px; display: none;">
                            <label class="button2">
                                <input type="radio" name="frame-size" value="640x416"> <!--1280x832-->
                                <span>1280 x 832</span>
                            </label>
                            <label class="button2">
                                <input type="radio" name="frame-size" value="1512x982">
                                <span>1512 x 982</span>
                            </label>
                            <label class="button2">
                                <input type="radio" name="frame-size" value="1728x1117">
                                <span>1728 x 1117</span>
                            </label>
                            <label class="button2">
                                <input type="radio" name="frame-size" value="1440x1024">
                                <span>1440 x 1024</span>
                            </label>
                        </div>
                        <div id="watchframe" style="margin-bottom: 30px; display: none;">
                            <label class="button2">
                                <input type="radio" name="frame-size" value="176x215">
                                <span>Apple Watch 41mm</span>
                            </label>
                            <label class="button2">
                                <input type="radio" name="frame-size" value="198x242">
                                <span>Apple Watch 45mm</span>
                            </label>
                            <label class="button2">
                                <input type="radio" name="frame-size" value="368x448"><!--184x224-->
                                <span>Apple Watch 44mm</span>
                            </label>
                            <label class="button2">
                                <input type="radio" name="frame-size" value="162x197">
                                <span>Apple Watch 40mm</span>
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <!--<h2 id="result" class="comment-head" style="display: block;">Result</h2>-->

            <div class="container-cropper" style="max-width: 100%; max-height:600px; ">
                <div>
                    <img id="generatedImage" src="" alt="생성된 이미지"
                        style="max-width: 100%;max-height:600px; display:none;">
                </div>
                <div>
                    <canvas id="croppedCanvas" style="max-width: 100%;max-height:600px;margin-bottom: -100px;"></canvas>
                </div>

                <button id="cropButton" class="button-generate">Crop</button>

            </div>
        </section>


        <section id="aboutme" class="imageEdit-section" style="display: block;">
            <h2 class="comment-head">Image Editor</h2>
            <div class="container2 disable">
                <div class="wrapper-imgeditor"> <!--이미 style sheet에 존재-->

                    <div class="editor-panel">
                        <div class="filter">
                            <label class="title3">Filters</label> <!--이미 style sheet에 존재-->
                            <div class="options">
                                <button id="brightness" class="active">Brightness</button>
                                <button id="saturation">Saturation</button>
                                <button id="inversion">Inversion</button>
                                <button id="grayscale">Grayscale</button>
                            </div>
                            <div class="slider">
                                <div class="filter-info">
                                    <p class="name">Brightness</p>
                                    <p class="value">100%</p>
                                </div>
                                <input type="range" value="100" min="0" max="200">
                            </div>
                        </div>
                        <div class="rotate">
                            <label class="title3">Rotate & Flip</label>
                            <div class="options">
                                <button id="left"><i class="fa-solid fa-rotate-left"></i></button>
                                <button id="right"><i class="fa-solid fa-rotate-right"></i></button>
                                <button id="horizontal"><i class='bx bx-reflect-vertical'></i></button>
                                <button id="vertical"><i class='bx bx-reflect-horizontal'></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="preview-img" style="background-color: #E7E3E3">
                        <img src="https://codingnepalweb.com/demos/image-editor-javascript/image-placeholder.svg"
                            alt="preview-img">
                    </div>

                    <div class="controls"
                        style="display:flex; width: 100%; justify-content: space-between; margin-top: 20px;">
                        <div>
                            <button class="reset-filter">Reset Filters</button>
                        </div>

                        <div class="row">
                            <button id="toggleButton" class="choose-img">Share Image</button>
                            <button class="save-img">Save Image</button>

                        </div>
                    </div>
                    <div id="popups">
                        <div class="popup" id="popup-1">
                            <div class="overlay"></div>
                            <div class="content">
                                <div class="close-btn" onclick="togglePopup('popup-1')"></div>
                                <h2 class="comment-head" style="margin-top:100px">Write an Email Address</h2>
                                <form id=emailform method="POST" action="{% url 'emailEditedImage' %}"
                                    enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <textarea id="email2" class="textarea" name="email2" rows=5
                                        placeholder="abc123@gmail.com"></textarea>
                                    <!-- <input type="hidden" id="generatedImage" name="generatedImage"
                                        value="{{ generated_image_model.generated_image.url }}"> -->

                                    <button id="submit" class="button" style="float:right">보내기</button>
                                </form>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </section>
        <script src="{% static 'js/apikey.js' %}"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.0/cropper.min.js"></script>
        <script type="text/javascript" src="{% static 'js/imageEdit.js' %}"></script>
        <script>

            /*Image editor*/
            const fileInput = document.querySelector(".file-input"),
                filterOptions = document.querySelectorAll(".filter button"),
                filterName = document.querySelector(".filter-info .name"),
                filterValue = document.querySelector(".filter-info .value"),
                filterSlider = document.querySelector(".slider input"),
                rotateOptions = document.querySelectorAll(".rotate button"),
                //previewImg = document.querySelector(".preview-img img"),
                resetFilterBtn = document.querySelector(".reset-filter"),
                chooseImgBtn = document.querySelector(".choose-img"),
                saveImgBtn = document.querySelector(".save-img");
            let brightness = "100", saturation = "100", inversion = "0", grayscale = "0";
            let rotate = 0, flipHorizontal = 1, flipVertical = 1;

            const applyFilter = () => {
                previewImg.style.transform = `rotate(${rotate}deg) scale(${flipHorizontal}, ${flipVertical})`;
                previewImg.style.filter = `brightness(${brightness}%) saturate(${saturation}%) invert(${inversion}%) grayscale(${grayscale}%)`;
            }
            filterOptions.forEach(option => {
                option.addEventListener("click", () => {
                    document.querySelector(".active").classList.remove("active");
                    option.classList.add("active");
                    filterName.innerText = option.innerText;
                    if (option.id === "brightness") {
                        filterSlider.max = "200";
                        filterSlider.value = brightness;
                        filterValue.innerText = `${brightness}%`;
                    } else if (option.id === "saturation") {
                        filterSlider.max = "200";
                        filterSlider.value = saturation;
                        filterValue.innerText = `${saturation}%`
                    } else if (option.id === "inversion") {
                        filterSlider.max = "100";
                        filterSlider.value = inversion;
                        filterValue.innerText = `${inversion}%`;
                    } else {
                        filterSlider.max = "100";
                        filterSlider.value = grayscale;
                        filterValue.innerText = `${grayscale}%`;
                    }
                });
            });
            const updateFilter = () => {
                filterValue.innerText = `${filterSlider.value}%`;
                const selectedFilter = document.querySelector(".filter .active");
                if (selectedFilter.id === "brightness") {
                    brightness = filterSlider.value;
                } else if (selectedFilter.id === "saturation") {
                    saturation = filterSlider.value;
                } else if (selectedFilter.id === "inversion") {
                    inversion = filterSlider.value;
                } else {
                    grayscale = filterSlider.value;
                }
                applyFilter();
            }
            rotateOptions.forEach(option => {
                option.addEventListener("click", () => {
                    if (option.id === "left") {
                        console.log('left')
                        rotate -= 90;
                    } else if (option.id === "right") {
                        rotate += 90;
                    } else if (option.id === "horizontal") {
                        flipHorizontal = flipHorizontal === 1 ? -1 : 1;
                    } else {
                        flipVertical = flipVertical === 1 ? -1 : 1;
                    }
                    applyFilter();
                });
            });
            const resetFilter = () => {
                brightness = "100"; saturation = "100"; inversion = "0"; grayscale = "0";
                //rotate = 0; flipHorizontal = 1; flipVertical = 1;
                filterOptions[0].click();
                applyFilter();
            }
            const saveImage = () => {
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");
                canvas.width = previewImg.naturalWidth;
                canvas.height = previewImg.naturalHeight;

                ctx.filter = `brightness(${brightness}%) saturate(${saturation}%) invert(${inversion}%) grayscale(${grayscale}%)`;
                ctx.translate(canvas.width / 2, canvas.height / 2);
                if (rotate !== 0) {
                    ctx.rotate(rotate * Math.PI / 180);
                }
                ctx.scale(flipHorizontal, flipVertical);
                ctx.drawImage(previewImg, -canvas.width / 2, -canvas.height / 2, canvas.width, canvas.height);

                const link = document.createElement("a");
                link.download = "image.jpg";
                link.href = canvas.toDataURL();
                link.click();
            }
            const ShareImage = () => {
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");
                canvas.width = previewImg.naturalWidth;
                canvas.height = previewImg.naturalHeight;

                ctx.filter = `brightness(${brightness}%) saturate(${saturation}%) invert(${inversion}%) grayscale(${grayscale}%)`;
                ctx.translate(canvas.width / 2, canvas.height / 2);
                if (rotate !== 0) {
                    ctx.rotate(rotate * Math.PI / 180);
                }
                ctx.scale(flipHorizontal, flipVertical);
                ctx.drawImage(previewImg, -canvas.width / 2, -canvas.height / 2, canvas.width, canvas.height);
 
                const imageData = canvas.toDataURL("image/jpeg");
                console.log(imageData)

            }
            filterSlider.addEventListener("input", updateFilter);
            resetFilterBtn.addEventListener("click", resetFilter);
            saveImgBtn.addEventListener("click", saveImage);
            chooseImgBtn.addEventListener("click", ShareImage);
            //fileInput.addEventListener("change", loadImage);
            //chooseImgBtn.addEventListener("click", () => fileInput.click());

            /*share image*/
            //var generatedImage = document.getElementById("result-image").src;
            document.addEventListener("DOMContentLoaded", function () {
                var emailForm = document.getElementById("emailform");
                emailForm.addEventListener("submit", function (e) {
                    e.preventDefault(); // 폼 제출 동작 막음

                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");
                    canvas.width = previewImg.naturalWidth;
                    canvas.height = previewImg.naturalHeight;

                    ctx.filter = `brightness(${brightness}%) saturate(${saturation}%) invert(${inversion}%) grayscale(${grayscale}%)`;
                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    if (rotate !== 0) {
                        ctx.rotate(rotate * Math.PI / 180);
                    }
                    ctx.scale(flipHorizontal, flipVertical);
                    ctx.drawImage(previewImg, -canvas.width / 2, -canvas.height / 2, canvas.width, canvas.height);
    
                    const imageData = canvas.toDataURL("image/jpeg");
                    var email2 = document.getElementById("email2").value;

                    // POST 요청
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "{% url 'emailEditedImage' %}", true);
                    // CSRF 토큰을 헤더에 설정
                    xhr.setRequestHeader("X-CSRFToken", '{{csrf_token}}');
                    // xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                    xhr.setRequestHeader("Content-Type", "multipart/form-data");


                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === 4) {
                            if (xhr.status === 200) {
                                var response = JSON.parse(xhr.responseText);
                                alert(response.message);
                            } else {
                                alert('오류 발생');
                            }
                        }
                    };

                    // FormData 객체를 생성하여 데이터 전송
                    const formData = new FormData();
                    formData.append("email2", email2);
                    formData.append("imageData", imageData);
                    for (const x of formData) {
                    console.log(x);
                    };
                    xhr.send(formData);
                    console.log('성공')
                });
            });

        </script>

        <footer>
            <div id="copyright">
                <span>All contents Copyright 2021 by Chaeran Yoo. All rights reserved<br>
                    Contact mail : ran4088@sookmyung.ac.kr</span>
            </div>
        </footer>
    </div>
    </div>
</body>

</html>